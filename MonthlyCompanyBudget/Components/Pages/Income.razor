@page "/income"
@using Microsoft.EntityFrameworkCore
@using MonthlyCompanyBudget.Core.Entities
@using MonthlyCompanyBudget.Data
@inject ISnackbar Snackbar

<MudToolBar>
    <MudText Typo="Typo.h6">Monthly Income</MudText>
    <MudSpacer></MudSpacer>
    <MudSpacer></MudSpacer>
    <MudSpacer></MudSpacer>
    <MudSpacer></MudSpacer>
    <MudSpacer></MudSpacer>
    <MudText Class="mr-2">Month:</MudText>
    <MudSelect T="DateTime" Value="@_monthFilter" ToStringFunc="@(x => x.ToString("MMMM yyyy"))" ValueChanged="GetMonthlyBudgetItems">
        @foreach(var item in _monthlyBudgets)
        {
            <MudSelectItem Value="@item.Date">@item.Date.ToString("MMMM yyyy")</MudSelectItem>            
        }
    </MudSelect>    
    <MudSpacer></MudSpacer>
    <MudTooltip Text="Add Month">
        <MudIconButton Icon="@Icons.Material.Outlined.Add" OnClick="@(() => _addMonthlyBudgetDialogVisible = true)" />
    </MudTooltip>
    <MudTooltip Text="Save Changes">
        <MudIconButton Icon="@Icons.Material.Outlined.Save" OnClick="Save" />
    </MudTooltip>
</MudToolBar>
<MudGrid Spacing="0" Class="border border-solid rounded" Style="@($"border-color: {Colors.Gray.Lighten3};")">
    <MudItem md="4" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
        <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">INCOME</MudText>
    </MudItem>
    <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
        <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">ESTIMATED</MudText>
    </MudItem>
    <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
        <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">ACTUAL</MudText>
    </MudItem>
    <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
        <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">TOP 5 AMOUNT</MudText>
    </MudItem>
    <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
        <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">DIFFERENCE</MudText>
    </MudItem>
    <MudItem md="12" lg="12">
        @foreach (var item in _budgetItems)
        {
            <MudForm Model="item">
                <MudGrid Spacing="0">                    
                    <MudItem md="4" Class="border-b border-r border-solid pa-1" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                        <MudField Class="no-underline">@item.BudgetItemType.Name</MudField>                        
                    </MudItem>
                    <MudItem md="2" Class="border-b border-r border-solid pa-1" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                        <MudNumericField @bind-Value="@item.EstimatedValue" Class="no-underline text-right" Format="N2"></MudNumericField>
                    </MudItem>
                    <MudItem md="2" Class="border-b border-r border-solid pa-1" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                        <MudNumericField @bind-Value="@item.ActualValue" Class="no-underline text-right" Format="N2"></MudNumericField>
                    </MudItem>
                    <MudItem md="2" Class="border-b border-r border-solid pa-1" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                        <MudField Class="no-underline text-right">@item.Top5Amount.ToString("N2")</MudField>
                    </MudItem>
                    <MudItem md="2" Class="border-b border-r border-solid pa-0 pr-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                        <MudField Class="no-underline text-right"><MudText Class="@(item.Difference < 0 ? "mud-secondary-text" : "")">@item.Difference.ToString("N2")</MudText></MudField>
                    </MudItem>
                </MudGrid>
            </MudForm>
        }
    </MudItem>
    <MudItem md="12" lg="12">
        <MudGrid Spacing="0">
            <MudItem md="4" Class="border-b border-r border-solid pa-1" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudField Class="no-underline"><b>Total Income</b></MudField>
            </MudItem>
            <MudItem md="2" Class="border-b border-r border-solid pa-1" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudField Class="no-underline text-right"><b>@_budgetItems.Sum(x => x.EstimatedValue).ToString("N2")</b></MudField>
            </MudItem>
            <MudItem md="2" Class="border-b border-r border-solid pa-1" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudField Class="no-underline text-right"><b>@_budgetItems.Sum(x => x.ActualValue).ToString("N2")</b></MudField>
            </MudItem>
            <MudItem md="2" Class="border-b border-r border-solid pa-1" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")"></MudItem>
            <MudItem md="2" Class="border-b border-r border-solid pa-0 pr-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudField Class="no-underline text-right"><MudText Class="@(_budgetItems.Sum(x => x.Difference) < 0 ? "mud-secondary-text" : "")"><b>@_budgetItems.Sum(x => x.Difference).ToString("N2")</b></MudText></MudField>
            </MudItem>
        </MudGrid>
    </MudItem>
</MudGrid>
<MudDialog @bind-Visible="_addMonthlyBudgetDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">
            Please select Year and Month
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_addMonthlyBudgetForm">
            <MudDatePicker @bind-Date="_monthOf" OpenTo="OpenTo.Year" FixDay="1" DateFormat="MMMM yyyy" Required/>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _addMonthlyBudgetDialogVisible = false)" Class="px-10">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="AddMonth" Class="px-10">Add</MudButton>
    </DialogActions>
</MudDialog>
<style>
    .no-underline .mud-input.mud-input-text.mud-input-underline:before {
        border-bottom: none;
    }

    .text-right .mud-input input.mud-input-slot,
    .text-right .mud-input .mud-input-slot {
        text-align: right;
    }

    .normal-text-on-disabled .mud-input input.mud-input-slot {
        color: black;
    }

    .warning-text .mud-input input.mud-input-slot {
        color: black;
    }
</style>

@code {
    DateTime? _monthOf;
    DateTime _monthFilter;
    private bool _addMonthlyBudgetDialogVisible;
    MudForm _addMonthlyBudgetForm;
    List<MonthlyBudgetItem> _budgetItems = new List<MonthlyBudgetItem>();
    List<MonthlyBudget> _monthlyBudgets = new List<MonthlyBudget>();

    protected override async Task OnInitializedAsync()
    {
        await GetMonthlyBudgets();
        await GetMonthlyBudgetItems(_monthFilter);
    }


    private void FilterMonthlyBudget(DateTime month)
    {
        _monthFilter = month;
    }

    private async Task GetMonthlyBudgetItems(DateTime month)
    {
        _monthFilter = month;
        MonthlyBudget? monthlyBudget = null;

        using (var context = new ApplicationDbContext())
        {
            var incomeType = await context.BudgetItemTypes.FirstOrDefaultAsync(x => x.Category == Core.Enums.BudgetItemTypeCategory.Income);

            var monthOf = new DateTime(month.Year, month.Month, month.Day, 0, 0, 0);
            monthlyBudget = await context.MonthlyBudgets.Include(x => x.Items).ThenInclude(x => x.BudgetItemType).FirstOrDefaultAsync(x => x.Date == monthOf);

            if (incomeType != null && monthlyBudget != null)
            {
                _budgetItems = monthlyBudget.Items;
            }
        }
    }

    private async Task AddMonth()
    {
        await _addMonthlyBudgetForm.Validate();
        if (_addMonthlyBudgetForm.IsValid)
        {
            using(var context = new ApplicationDbContext())
            {
                var budgetItemTypes = context.BudgetItemTypes.Where(x => x.Category == Core.Enums.BudgetItemTypeCategory.Income).ToList();

                var monthlyBudget = new MonthlyBudget { Date = _monthOf.Value };

                foreach (var budgetItemType in budgetItemTypes)
                {
                    monthlyBudget.Items.Add(new MonthlyBudgetItem { BudgetItemTypeId = budgetItemType.Id, EstimatedValue = 0, ActualValue = 0 });
                }

                context.MonthlyBudgets.Add(monthlyBudget);
                await context.SaveChangesAsync();

                _addMonthlyBudgetDialogVisible = false;

                await GetMonthlyBudgets();
                await GetMonthlyBudgetItems(monthlyBudget.Date);
            }
        }
    }

    private async Task Save()
    {
        using(var context = new ApplicationDbContext())
        {
            foreach (var item in _budgetItems)
            {
                context.MonthlyBudgetItems.Update(item);
            }
            await context.SaveChangesAsync();
        }
        Snackbar.Add("Invoice saved successfully", MudBlazor.Severity.Success);
    }

    private async Task GetMonthlyBudgets()
    {
        //get the last 12 months
        using(var context = new ApplicationDbContext())
        {
            _monthlyBudgets = await context.MonthlyBudgets.OrderByDescending(x => x.Date).Take(12).ToListAsync();
        }
        //_monthlyBudgetFilter = _monthlyBudgets.FirstOrDefault();
        _monthFilter = _monthlyBudgets.FirstOrDefault().Date;
    }
}

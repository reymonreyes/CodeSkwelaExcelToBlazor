@page "/employees"
@using WeeklyTimesheet.Shared
@using WeeklyTimesheet.ViewModels

<MudPaper Class="my-2">
    <MudToolBar>
        <MudText Typo="Typo.h6">Employees</MudText>
        <MudSpacer></MudSpacer>
        <MudTooltip Text="Add New Employee">
            <MudIconButton Icon="@Icons.Material.Outlined.Add" OnClick="AddNewEmployee"/>
        </MudTooltip>
    </MudToolBar>
</MudPaper>
<MudGrid>
    <MudItem md="4" lg="4">
        <MudSelect T="string" Label="Find Employee" Variant="Variant.Outlined" @bind-Value="_selectedValue">
            @foreach (var employee in _employees)
            {
            <MudSelectItem Value="@employee.Name">@employee.Name</MudSelectItem>                
            }            
        </MudSelect>
    </MudItem>
</MudGrid>
<MudSimpleTable Bordered="true" Hover="true">
    <thead>
        <tr>
            <th>Name</th>
            <th>Manager</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var employee in _employees)
        {
            <tr>
                <td>@employee.Name</td>
                <td>@employee?.Manager?.Name</td>
                <td>
                    <MudTooltip Text="Edit">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" Href="" OnClick="@(() => EditEmployee(employee))"></MudIconButton>
                    </MudTooltip>
                </td>
            </tr>
        }
    </tbody>
</MudSimpleTable>
<MudDialog @bind-Visible="_showEmployeeFormModal" Options="@(new DialogOptions{ MaxWidth = MaxWidth.Large })">
    <TitleContent>
        <MudText Typo="Typo.h6">@(_employeeFormMode == FormMode.Create ? "Add New" : (_employeeFormMode == FormMode.Edit ? "Edit" : "")) Employee</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_employeeForm">
            <MudTextField @bind-Value="_employee.Name" Label="Name" Required="true"/>
            <MudAutocomplete Label="Manager" @bind-Value="_employee.Manager" SearchFunc="FindManager" ToStringFunc="@(x => x?.Name ?? "")"/>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@(() => _showEmployeeFormModal = false)" Class="px-10">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveEmployee" Class="px-10">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<Employee> _employees = new List<Employee>();
    private string _selectedValue;
    private bool _showEmployeeFormModal;
    private FormMode _employeeFormMode = FormMode.ReadOnly;
    private Employee _employee = null;
    private Employee _selectedManager;
    private MudForm? _employeeForm;

    protected override void OnInitialized()
    {
        var manager = new Employee { Id = 1, Name = "John Doe" };
        var manager2 = new Employee { Id = 2, Name = "Alpha Bravo" };

        _employees.Add(manager);
        _employees.Add(manager2);
        _employees.Add(new Employee { Id = 3, Name = "Bravo Charlie", Manager = manager });
        _employees.Add(new Employee { Id = 4, Name = "Charlie Delta", Manager = manager2 });
        _employees.Add(new Employee { Id = 5, Name = "Delta Echo", Manager = manager });
        _employees.Add(new Employee { Id = 6, Name = "Echo Foxtrot", Manager = manager });
        _employees.Add(new Employee { Id = 7, Name = "Foxtrot Golf", Manager = manager2 });
        _employees.Add(new Employee { Id = 8, Name = "Golf Hotel", Manager = manager });
        _employees.Add(new Employee { Id = 9, Name = "Hotel India", Manager = manager2 });
        _employees.Add(new Employee { Id = 10, Name = "India Julliett", Manager = manager });
        _employees.Add(new Employee { Id = 11, Name = "Julliett Kilo", Manager = manager });
        _employees.Add(new Employee { Id = 12, Name = "Kilo Lima", Manager = manager2 });
        _employees.Add(new Employee { Id = 13, Name = "Lima Mike", Manager = manager2 });
        _employees.Add(new Employee { Id = 14, Name = "Mike November", Manager = manager });
        _employees.Add(new Employee { Id = 15, Name = "November Oscar", Manager = manager });
    }

    private void AddNewEmployee()
    {
        _showEmployeeFormModal = true;
        _employeeFormMode = FormMode.Create;
        _employee = new Employee();
    }

    private void EditEmployee(Employee employee)
    {
        _employee = employee;
        _showEmployeeFormModal = true;
        _employeeFormMode = FormMode.Edit;
    }

    private async Task SaveEmployee()
    {
        await _employeeForm.Validate();
        if (!_employeeForm.IsValid)
            return;

        _employees.Add(_employee);

        _showEmployeeFormModal = false;
        _employeeFormMode = FormMode.ReadOnly;
    }

    private async Task<IEnumerable<Employee>> FindManager(string value, CancellationToken token)
    {
        var result = _employees.ToList();

        if (string.IsNullOrEmpty(value))
        {
            return result;
        }

        return result.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }
}

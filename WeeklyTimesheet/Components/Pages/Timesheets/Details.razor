@page "/timesheets/{id:int}"
@using WeeklyTimesheet.Core.Repositories
@using WeeklyTimesheet.ViewModels
@inject ITimesheetsRepository TimesheetsRepository
@inject ISnackbar Snackbar

<MudPaper Class="my-2">
    <MudToolBar>
        <MudText Typo="Typo.h6">Time Sheet Details</MudText>
        <MudSpacer></MudSpacer>
        <MudTooltip Text="Save">
            <MudIconButton Icon="@Icons.Material.Outlined.Save" OnClick="Save"/>
        </MudTooltip>
    </MudToolBar>
</MudPaper>
<MudGrid Class="pa-4">
    <MudItem sm="3" md="3" lg="3"><MudText><b>Employee</b><MudText Class="pl-4" Inline="true">@_timesheet.Employee.Name</MudText></MudText></MudItem>
    <MudItem sm="3" md="3" lg="3"><MudText><b>Manager</b><MudText Class="pl-4" Inline="true">@_timesheet.Employee.Manager.Name</MudText></MudText></MudItem>
    <MudItem sm="3" md="3" lg="3"><MudText><b>Week Start</b><MudText Class="pl-4" Inline="true">@_timesheet.WeekStart.ToString("yyyy-MM-dd")</MudText></MudText></MudItem>
</MudGrid>
<MudGrid Spacing="0">
    <MudItem sm="12" md="12" lg="12" xl="12">
        <MudGrid Spacing="0" Class="mud-theme-primary">
            <MudItem md="1" Class="border border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Date</MudText></MudItem>
            <MudItem md="2" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Time In</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Breaks<br/>(minutes)</MudText></MudItem>
            <MudItem md="2" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Time Out</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Regular<br/>h:mm</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Total<br/>h:mm</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Overtime<br/>h:mm</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Sick<br/>h:mm</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Holiday<br/>h:mm</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center"><MudText Align="Align.Center" Typo="Typo.subtitle2">Vacation<br/>h:mm</MudText></MudItem>
        </MudGrid>
    </MudItem>    
    @for (int i = 0; i < _timesheet.Logs.Count; i++)
    {
        var timelog = _timesheet.Logs[i];
        <MudItem sm="12" md="12" lg="12" xl="12">
            <MudGrid Spacing="0">
                <!--Day of week-->
                <MudItem md="1" Class="@(SetBorder(i, 0) + " border-solid pa-1 align-content-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@timelog.DayOfWeek.ToString("yyyy-MM-dd")</MudText></MudItem>
                <!--Time In-->
                <MudItem md="2" Class="@(SetBorder(i, 1) + " border-solid pa-1 align-content-center text-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                    <MudTimePicker AmPm="true" Class="no-underline" @bind-Time="timelog.TimeIn" />
                </MudItem>
                <!--Breaks-->
                <MudItem md="1" Class="@(SetBorder(i, 2) + " border-solid pa-1 align-content-center text-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                    <MudNumericField Variant="Variant.Text" Min="0" Max="60" Class="no-underline" @bind-Value="timelog.BreakMinutes"/>
                </MudItem>
                <!--Time Out-->
                <MudItem md="2" Class="@(SetBorder(i, 3) + " border-solid pa-1 align-content-center text-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                    <MudTimePicker AmPm="true" Class="no-underline" @bind-Time="timelog.TimeOut" />
                </MudItem>                
                <!--Regular-->
                <MudItem md="1" Class="@(SetBorder(i, 4) + " border-solid pa-1 align-content-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">&nbsp; @timelog.RegularHours?.ToString(@"h\:mm")</MudText></MudItem>
                <!--Total-->
                <MudItem md="1" Class="@(SetBorder(i, 4) + " border-solid pa-1 align-content-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">&nbsp; @timelog.WorkHours?.ToString(@"h\:mm")</MudText></MudItem>
                <!--Overtime-->
                <MudItem md="1" Class="@(SetBorder(i, 6) + " border-solid pa-1 align-content-center text-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                    <MudTooltip>
                        <ChildContent>
                            <MudTextField T="string" Variant="@Variant.Text" Validation="ValidateTime" Class="hide-error no-underline" OnlyValidateIfDirty="true" @bind-Value="timelog.OvertimeMinutesFormatted" />
                        </ChildContent>
                        <TooltipContent>
                            <MudText Typo="Typo.body2" Align="Align.Justify">Enter hours and minutes using<br /> the format H:MM such as <br />8:30 for 8 hours and 30 minutes,<br /> or 0:15 for 15 minutes.</MudText>
                        </TooltipContent>
                    </MudTooltip>
                </MudItem>
                <!--Sick-->
                <MudItem md="1" Class="@(SetBorder(i, 7) + " border-solid pa-1 align-content-center text-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                    <MudTooltip>
                        <ChildContent>
                            <MudTextField T="string" Variant="@Variant.Text" Validation="ValidateTime" Class="hide-error no-underline" OnlyValidateIfDirty="true" @bind-Value="timelog.SickMinutesFormatted" />
                        </ChildContent>
                        <TooltipContent>
                            <MudText Typo="Typo.body2" Align="Align.Justify">Enter hours and minutes using<br /> the format H:MM such as <br />8:30 for 8 hours and 30 minutes,<br /> or 0:15 for 15 minutes.</MudText>
                        </TooltipContent>
                    </MudTooltip>
                </MudItem>
                <!--Holiday-->
                <MudItem md="1" Class="@(SetBorder(i, 8) + " border-solid pa-1 align-content-center text-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                    <MudTooltip>
                        <ChildContent>
                            <MudTextField T="string" Variant="@Variant.Text" Validation="ValidateTime" Class="hide-error no-underline" OnlyValidateIfDirty="true" @bind-Value="timelog.HolidayMinutesFormatted" />
                        </ChildContent>
                        <TooltipContent>
                            <MudText Typo="Typo.body2" Align="Align.Justify">Enter hours and minutes using<br /> the format H:MM such as <br />8:30 for 8 hours and 30 minutes,<br /> or 0:15 for 15 minutes.</MudText>
                        </TooltipContent>
                    </MudTooltip>
                </MudItem>
                <!--Vacation-->
                <MudItem md="1" Class="@(SetBorder(i, 9) + " border-solid pa-1 align-content-center text-center")" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                    <MudTooltip>
                        <ChildContent>
                            <MudTextField T="string" Variant="@Variant.Text" Validation="ValidateTime" Class="hide-error no-underline" OnlyValidateIfDirty="true" @bind-Value="timelog.VacationMinutesFormatted" />
                        </ChildContent>
                        <TooltipContent>
                            <MudText Typo="Typo.body2" Align="Align.Justify">Enter hours and minutes using<br /> the format H:MM such as <br />8:30 for 8 hours and 30 minutes,<br /> or 0:15 for 15 minutes.</MudText>
                        </TooltipContent>
                    </MudTooltip>
                </MudItem>
            </MudGrid>
        </MudItem>
    }
    <MudItem sm="12" md="12" lg="12" xl="12">
        <MudGrid Spacing="0">
            <MudItem md="6" Class="pa-1 align-content-center"><MudText Align="Align.Center">&nbsp;</MudText></MudItem>
            <MudItem md="1" Class="border-x border-b border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center" Typo="Typo.subtitle2">Total</MudText></MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalWorkHoursFormatted</MudText></MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalOvertimeHoursFormatted</MudText></MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalSickHoursFormatted</MudText></MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalHolidayHoursFormatted</MudText></MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalVacationHoursFormatted</MudText></MudItem>
        </MudGrid>
        <MudGrid Spacing="0">
            <MudItem md="6" Class="pa-1 align-content-center"><MudText Align="Align.Center">&nbsp;</MudText></MudItem>
            <MudItem md="1" Class="border border-solid pa-1 align-content-center mud-theme-primary" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">&nbsp;</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center mud-theme-primary" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center" Typo="Typo.subtitle2">Regular</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center mud-theme-primary" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center" Typo="Typo.subtitle2">Overtime</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center mud-theme-primary" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center" Typo="Typo.subtitle2">Sick</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center mud-theme-primary" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center" Typo="Typo.subtitle2">Holiday</MudText></MudItem>
            <MudItem md="1" Class="border-y border-r border-solid pa-1 align-content-center mud-theme-primary" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center" Typo="Typo.subtitle2">Vacation</MudText></MudItem>
        </MudGrid>
        <MudGrid Spacing="0">
            <MudItem md="6" Class="pa-1 align-content-center"><MudText Align="Align.Center">&nbsp;</MudText></MudItem>
            <MudItem md="1" Class="border-x border-b border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center" Typo="Typo.subtitle2">Rate/hr:</MudText></MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center text-center" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudNumericField @bind-Value="@_timesheet.RegularRate" Variant="Variant.Text" Class="no-underline" Format="F2" />
            </MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center text-center" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudNumericField Value="@_timesheet.OvertimeRate" Variant="Variant.Text" Class="no-underline" Format="F2" Disabled="true"/>
            </MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center text-center" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudNumericField @bind-Value="@_timesheet.SickLeaveRate" Variant="Variant.Text" Class="no-underline" Format="F2" />
            </MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center text-center" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudNumericField @bind-Value="@_timesheet.HolidayLeaveRate" Variant="Variant.Text" Class="no-underline" Format="F2" />
            </MudItem>
            <MudItem md="1" Class="border-r border-b border-solid pa-1 align-content-center text-center" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                <MudNumericField @bind-Value="@_timesheet.VacationLeaveRate" Variant="Variant.Text" Class="no-underline" Format="F2" />
            </MudItem>
        </MudGrid>
        <MudGrid Spacing="0">
            <MudItem md="6" Class="pa-1 align-content-center"><MudText Align="Align.Center">&nbsp;</MudText></MudItem>
            <MudItem md="1" Class="border-x border-b border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center" Typo="Typo.subtitle2">Total pay:</MudText></MudItem>
            <MudItem md="1" Class="border-b border-r border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalRegularPay.ToString("F2")</MudText></MudItem>
            <MudItem md="1" Class="border-b border-r border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalOvertimePay.ToString("F2")</MudText></MudItem>
            <MudItem md="1" Class="border-b border-r border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalSickLeavePay.ToString("F2")</MudText></MudItem>
            <MudItem md="1" Class="border-b border-r border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalHolidayPay.ToString("F2")</MudText></MudItem>
            <MudItem md="1" Class="border-b border-r border-solid pa-1 align-content-center" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Center">@_timesheet.TotalVacationPay.ToString("F2")</MudText></MudItem>
            <MudItem md="6" lg="6" xl="6"><MudText>&nbsp;</MudText></MudItem>
            <MudItem md="3" lg="3" xl="3" Class="border-y border-l border-solid pa-1" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Left"><b>Grand total pay:</b></MudText></MudItem>
            <MudItem md="3" lg="3" xl="3" Class="border-y border-r border-solid pa-1" Style="@($"border-color: {Colors.Gray.Lighten3};")"><MudText Align="Align.Right"><b>@_timesheet.GrandTotalPay.ToString("F2")</b></MudText></MudItem>
        </MudGrid>
    </MudItem>
</MudGrid>
<style>
.mud-input-control.hide-error div.me-auto{
    display: none;
}
.no-underline .mud-input.mud-input-text.mud-input-underline:before {
    border-bottom: none;
}
.text-center input.mud-input-slot{
    text-align: center;
}
</style>

@code {
    private List<DateTime> _sample = new List<DateTime>();
    private Timesheet _timesheet = null;
    private Core.Entities.Timesheet _timesheetData = null;
    public IMask _leaveMask = new RegexMask(@"^[0-9]+:[0-5][0-9]$");

    [Parameter]
    public int Id { get; set; }

    protected override void OnInitialized()
    {        
        _timesheet = GetTimesheet(Id);
    }

    private string SetBorder(int row, int column)
    {
        if (row == 0 && column == 0)//top left
            return "border";
        else if (row > 0 && column == 0)
            return "border-l border-b border-r";
        else if (row == 0 && column > 0)
            return "border-b border-r border-t";
        else
            return "border-b border-r";
    }

    private bool ValidateTime(string value)
    {
        // "Time is required.";
        if (string.IsNullOrWhiteSpace(value))
            return true;

        // Regex: h:mm where h = any digits, mm = 00–59
        var regex = new System.Text.RegularExpressions.Regex(@"^[0-9]+:[0-5][0-9]$");
        if (!regex.IsMatch(value))
            return false;// "Invalid format. Use h:mm (e.g., 1:05, 12:30).";

        // Optional stricter check: ensure minutes are valid
        var parts = value.Split(':');
        if (int.TryParse(parts[1], out int minutes))
        {
            // "Minutes must be between 00 and 59.";
            if (minutes < 0 || minutes > 59)
                return false;
        }

        return true;
    }

    private Timesheet GetTimesheet(int id)
    {
        var result = new Timesheet();
        _timesheetData = TimesheetsRepository.Get(id);
        if(_timesheetData != null)
        {
            result = new Timesheet { Id = _timesheetData.Id, Employee = new Employee { Id = _timesheetData.EmployeeId, Name = _timesheetData?.Employee.Name, Manager = new Employee { Name = _timesheetData.Employee.Manager?.Name } }, WeekStart = _timesheetData.StartDate.ToLocalTime() };
            result.RegularRate = _timesheetData.RegularRate;
            //result.OvertimeRate = _timesheetData.OvertimeRate;
            result.SickLeaveRate = _timesheetData.SickLeaveRate;
            result.HolidayLeaveRate = _timesheetData.HolidayLeaveRate;
            result.VacationLeaveRate = _timesheetData.VacationLeaveRate;

            result.Logs = _timesheetData.Logs.Select(x => new TimesheetLog
            {
                Id = x.Id,
                TimesheetId = x.TimesheetId,
                DayOfWeek = x.DayOfWeek,
                TimeIn = x.TimeIn.HasValue ? x.TimeIn.Value.ToLocalTime().TimeOfDay : null,
                TimeOut = x.TimeOut.HasValue ? x.TimeOut.Value.ToLocalTime().TimeOfDay : null,                
                BreakMinutes = x.BreakMinutes,
                OvertimeMinutes = x.OvertimeMinutes,
                SickMinutes = x.SickMinutes,
                HolidayMinutes = x.HolidayMinutes,
                VacationMinutes = x.VacationMinutes
            }).ToList();
        }

        return result;
    }

    private void Save()
    {
        for (int i = 0; i < _timesheet.Logs.Count; i++)
        {
            var logView = _timesheet.Logs[i];
            var logData = _timesheetData.Logs[i];

            logData.TimeIn = logView.TimeIn.HasValue ? (new DateTime(logView.DayOfWeek.Year, logView.DayOfWeek.Month, logView.DayOfWeek.Day, logView.TimeIn.Value.Hours, logView.TimeIn.Value.Minutes, 0)).ToUniversalTime() : null;
            logData.TimeOut = logView.TimeOut.HasValue ? (new DateTime(logView.DayOfWeek.Year, logView.DayOfWeek.Month, logView.DayOfWeek.Day, logView.TimeOut.Value.Hours, logView.TimeOut.Value.Minutes, 0)).ToUniversalTime() : null;
            logData.BreakMinutes = logView.BreakMinutes;
            logData.OvertimeMinutes = logView.OvertimeMinutes;
            logData.SickMinutes = logView.SickMinutes;
            logData.HolidayMinutes = logView.HolidayMinutes;
            logData.VacationMinutes = logView.VacationMinutes;
        }

        _timesheetData.RegularRate = _timesheet.RegularRate;
        _timesheetData.OvertimeRate = _timesheet.OvertimeRate;
        _timesheetData.SickLeaveRate = _timesheet.SickLeaveRate;
        _timesheetData.HolidayLeaveRate = _timesheet.HolidayLeaveRate;
        _timesheetData.VacationLeaveRate = _timesheet.VacationLeaveRate;

        TimesheetsRepository.Update(_timesheetData);
        Snackbar.Add("Timesheet saved successfully.", Severity.Success);
    }
}

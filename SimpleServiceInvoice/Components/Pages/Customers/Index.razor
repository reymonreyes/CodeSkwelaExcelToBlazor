@page "/customers"

@using SimpleServiceInvoice.Data
@using SimpleServiceInvoice.Models
@inject IDialogService DialogService

<MudPaper Class="my-2">
    <MudToolBar>
        <MudText Typo="Typo.h6">Customers</MudText>
        <MudSpacer></MudSpacer>
        <MudTooltip Text="Create">
            <MudIconButton Icon="@Icons.Material.Outlined.Add" Href="customers/create" />
        </MudTooltip>
    </MudToolBar>
</MudPaper>
<MudSimpleTable Hover="true" Bordered="true" Dense="true">
    <thead>
        <tr><th>Name</th><th>Address</th><th>Phone</th><th>Email</th><th>Contact Name</th><th></th></tr>
    </thead>
    <tbody>
        @foreach (var customer in _customers)
        {
            <tr>
                <td>@customer.Name</td>
                <td>@customer.Address</td>
                <td>@customer.Phone</td>
                <td>@customer.Email</td>
                <td>@customer.ContactName</td>
                <td>
                    <MudTooltip Text="Edit">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" Href="@($"providers/{customer.Id}/edit")"></MudIconButton>
                    </MudTooltip>
                    <MudTooltip Text="Delete">
                        <MudIconButton Icon="@Icons.Material.Filled.Clear" Color="Color.Error" Size="Size.Small" OnClick="@(() => Delete(customer))"></MudIconButton>
                    </MudTooltip>
                </td>
            </tr>
        }
    </tbody>
</MudSimpleTable>

@code {
    private List<Customer> _customers = new List<Customer>();

    protected override void OnInitialized()
    {
        GetCustomers();
    }

    private async Task Delete(Customer customer)
    {
        var message = (MarkupString)$"This action is irreversible.<br/>Are you sure you want to delete this Customer?<br/><b>{customer.Name}</b>";
        var deleteConfirmed = await DialogService.ShowMessageBox("Delete Customer", message, "Yes", "No");

        if (deleteConfirmed.HasValue && deleteConfirmed.Value)
        {
            using (var context = new ApplicationDbContext())
            {
                context.Remove(customer);
                context.SaveChanges();
            }

            GetCustomers();
        }
    }

    private void GetCustomers()
    {
        using (var context = new ApplicationDbContext())
        {
            _customers = context.Customers.ToList();
        }
    }
}

@page "/invoices/{id:int}"
@using FluentValidation
@using System.Linq
@using Microsoft.EntityFrameworkCore
@using SimpleServiceInvoice.Data
@using SimpleServiceInvoice.Models
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudPaper Class="my-2">
    <MudToolBar Class="px-2">
        <MudTooltip Text="Back">
            <MudIconButton Icon="@Icons.Material.Outlined.ArrowBack" Href="invoices" />
        </MudTooltip>
        <MudText Typo="Typo.h6" Class="ml-2">@GetTitle()</MudText>
        <MudSpacer></MudSpacer>
        <MudTooltip Text="Save">
            <MudIconButton Icon="@Icons.Material.Outlined.Print" OnClick="Print" />
            <MudIconButton Icon="@Icons.Material.Outlined.Save" OnClick="Save" />
        </MudTooltip>
    </MudToolBar>
</MudPaper>
<MudPaper Class="pa-2 mt-2">
    <MudForm @ref="@_invoiceForm" Model="@_invoiceFormModel">
        <MudGrid>
            <MudItem xs="12" sm="12" md="6" lg="6">
                <MudSelect Value="@_invoiceFormModel.Provider" T="Provider" ToStringFunc="@(x => x?.Name)" For="@(() => _invoiceFormModel.Provider)" ValueChanged="GetServices" Label="Provider" Placeholder="Select..." Clearable="true" Required="true">
                    @foreach (Provider provider in _providers)
                    {
                        <MudSelectItem Value="@provider">@provider.Name</MudSelectItem>
                    }
                </MudSelect>                
            </MudItem>
            <MudItem xs="12" sm="12" md="6" lg="6">
                <MudSelect @bind-Value="_invoiceFormModel.Customer" ToStringFunc="@(x => x?.Name)" For="@(() => _invoiceFormModel.Customer)" Label="Customer" Placeholder="Select..." Clearable="true" Required="true">
                    @foreach (var customer in _customers)
                    {
                        <MudSelectItem Value="@customer">@customer.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="12" md="3" lg="3">
                <MudTextField @bind-Value="_invoiceFormModel.InvoiceNumber" Label="Invoice #" Required="true"></MudTextField>
            </MudItem>
            <MudItem xs="12" sm="12" md="3" lg="3">
                <MudDatePicker Label="Date" Editable="true" For="@(() => _invoiceFormModel.InvoiceDate)" @bind-Date="_invoiceFormModel.InvoiceDate" Placeholder="Select Date" Required="true"/>
            </MudItem>
            <MudItem xs="12" sm="12" md="6" lg="6">
                    <MudTextField @bind-Value="_invoiceFormModel.Terms" For="@(() => _invoiceFormModel.Terms)" Label="Terms"></MudTextField>
            </MudItem>
        </MudGrid>
    </MudForm>
</MudPaper>
<MudPaper Class="my-2 pa-2">
    <MudToolBar>
        <MudSelect Placeholder="Select..." @bind-Value="_selectedService">
            @foreach (var service in _services)
            {
                <MudSelectItem Value="@service">@service.Description</MudSelectItem>
            }
        </MudSelect>        
        <MudIconButton Icon="@Icons.Material.Outlined.Add" OnClick="AddNewItem"/>
    </MudToolBar>
    <MudGrid Spacing="0" Class="border border-solid rounded" Style="@($"border-color: {Colors.Gray.Lighten3};")">
        <MudItem md="1" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
        </MudItem>
        <MudItem md="5" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
            <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">DESCRIPTION</MudText>            
        </MudItem>
        <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
            <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">QTY</MudText>            
        </MudItem>
        <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
            <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">UNIT PRICE</MudText>            
        </MudItem>
        <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
            <MudText Align="Align.Center" Style="@($"font-size: 0.875rem;color: {Colors.Gray.Darken3};font-weight: 500;")">AMOUNT</MudText>            
        </MudItem>
        <MudItem md="12" lg="12">
            @foreach (var item in _invoiceFormModel.Items)
            {
                <MudForm Model="item">
                    <MudGrid Spacing="0">
                        <MudItem md="1" Class="border-b border-r border-solid pa-2 mud-select" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                            <MudIconButton Icon="@Icons.Material.Filled.Clear" Color="Color.Error" Size="Size.Small" Variant="Variant.Outlined" OnClick="@(() => RemoveItem(item))"></MudIconButton>
                        </MudItem>
                        <MudItem md="5" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                            <MudSelect T="ProviderService" Value="item.Service" ToStringFunc="@(x => x?.Description)" For="@(() => item.Service)" Placeholder="Select..." Required="true" ValueChanged="@((val) => SetServiceItem(val, item))" Class="no-underline">
                                @foreach (var service in _services)
                                {
                                    <MudSelectItem Value="@service">@service.Description</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                            <MudNumericField @bind-Value="@item.Quantity" Class="no-underline text-right"></MudNumericField>                            
                        </MudItem>
                        <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                            <MudNumericField @bind-Value="@item.UnitPrice" Class="no-underline text-right"></MudNumericField>                            
                        </MudItem>
                        <MudItem md="2" Class="border-b border-r border-solid pa-2" Square="true" Style="@($"border-color: {Colors.Gray.Lighten3};")">
                            <MudField Class="no-underline text-right">@item.Total.ToString("N2")</MudField>
                        </MudItem>
                    </MudGrid>
                </MudForm>
            }            
        </MudItem>
    </MudGrid>
</MudPaper>
<style>
.no-underline .mud-input.mud-input-text.mud-input-underline:before {
    border-bottom: none;
}

.text-right .mud-input input.mud-input-slot,
.text-right .mud-input .mud-input-slot{
    text-align: right;
}

.normal-text-on-disabled .mud-input input.mud-input-slot {
    color: black;
}
</style>

@code {
    DateTime? _date = DateTime.Now;
    List<Provider> _providers = new List<Provider>();
    List<Customer> _customers = new List<Customer>();
    List<ProviderService> _services = new List<ProviderService>();
    ProviderService? _selectedService;    
    MudForm _invoiceForm;
    InvoiceViewModel _invoiceFormModel = new InvoiceViewModel();
    ViewMode _viewMode = ViewMode.Create;
    List<int> _itemsToRemove = new List<int>();

    [Parameter]
    public int Id { get; set; }

    protected override void OnInitialized()
    {
        if (Id > 0)
            _viewMode = ViewMode.Update;

        GetProviders();
        GetCustomers();
        InitializeModel();

        GetInvoice();
    }

    private void InitializeModel()
    {
        switch (_viewMode)
        {
            case ViewMode.Create:
                _invoiceFormModel.InvoiceDate = DateTime.Now;
                _invoiceFormModel.InvoiceNumber = GetNextInvoiceNumber().ToString();
                break;
            case ViewMode.Update:
                GetInvoice();
                break;
        }

    }

    private void GetInvoice()
    {
        Invoice invoice = null;

        using(var context = new ApplicationDbContext())
        {
            invoice = context.Invoices.Include(x => x.Provider).ThenInclude(x => x.Services).Include(x => x.Customer).Include(x => x.Items).ThenInclude(x => x.ProviderService).FirstOrDefault(x => x.Id == Id);
        }

        if(invoice != null)
        {
            //compose the view model
            _services = invoice.Provider.Services.ToList();
            _invoiceFormModel.Provider = invoice.Provider;
            _invoiceFormModel.Customer = invoice.Customer;
            _invoiceFormModel.InvoiceNumber = invoice.InvoiceNumber;
            _invoiceFormModel.InvoiceDate = invoice.Date;
            _invoiceFormModel.Terms = invoice.Terms;
            _invoiceFormModel.Items = invoice.Items.Select(x => new InvoiceItemViewModel { Id = x.Id, Service = x.ProviderService, Quantity = x.Quantity, UnitPrice = x.UnitPrice }).ToList();
        }
    }

    private void GetProviders()
    {
        using(var context = new ApplicationDbContext())
        {
            _providers = context.Providers.ToList();
        }
    }

    private void GetCustomers()
    {
        using(var context = new ApplicationDbContext())
        {
            _customers = context.Customers.ToList();
        }
    }

    private void GetServices(Provider provider)
    {
        _invoiceFormModel.Provider = provider;
        if (_invoiceFormModel.Provider is null)
        {
            _services = new List<ProviderService>();
            return;
        }

        using (var context = new ApplicationDbContext())
        {
            _services = context.ProviderServices.Where(x => x.ProviderId == _invoiceFormModel.Provider.Id).ToList();
        }
        _invoiceFormModel.Items = new List<InvoiceItemViewModel>();
    }

    private int GetNextInvoiceNumber()
    {
        int nextId = 0;
        using (var context = new ApplicationDbContext())
        {
            var seqQuery = context.Database.SqlQuery<int>($"SELECT seq FROM sqlite_sequence WHERE name = 'Invoices'").ToList();
            if (seqQuery != null && seqQuery.Any())
                nextId = seqQuery.FirstOrDefault();
        }

        return nextId + 1;
    }

    private void SetServiceItem(ProviderService service, InvoiceItemViewModel model)
    {
        model.Service = service;
        model.Quantity = 1;
        model.UnitPrice = service.UnitPrice;
    }

    private void AddNewItem()
    {
        if (_selectedService == null)
            return;

        var newItem = new InvoiceItemViewModel();
        newItem.Service = _selectedService;
        newItem.Quantity = 1;
        newItem.UnitPrice = _selectedService.UnitPrice;
        _invoiceFormModel.Items.Add(newItem);
        _selectedService = null;
    }    

    private async Task Save()
    {
        await _invoiceForm.Validate();

        if (!_invoiceForm.IsValid)
            return;

        var invoice = new Invoice();
        invoice.Id = Id;
        invoice.ProviderId = _invoiceFormModel.Provider.Id;
        invoice.CustomerId = _invoiceFormModel.Customer.Id;
        invoice.Date = _invoiceFormModel.InvoiceDate.Value.ToUniversalTime();
        invoice.Terms = _invoiceFormModel.Terms;
        invoice.InvoiceNumber = _invoiceFormModel.InvoiceNumber;
        invoice.Items = _invoiceFormModel.Items.Select(x => new InvoiceItem { Id = x.Id, ProviderServiceId = x.Service.Id, Quantity = x.Quantity, UnitPrice = x.UnitPrice }).ToList();

        using (var context = new ApplicationDbContext())
        {
            if (_viewMode == ViewMode.Create)
            {
                context.Invoices.Add(invoice);                
            }
            else if (_viewMode == ViewMode.Update)
            {
                var itemsToRemove = _itemsToRemove.Select(x => new InvoiceItem { Id = x }).ToList();

                foreach (var item in itemsToRemove)
                    context.Entry(item).State = EntityState.Deleted;

                context.Invoices.Update(invoice);
            }

            var result = context.SaveChanges();
            Id = invoice.Id;
        }

        if (_viewMode == ViewMode.Create)
        {
            NavigationManager.NavigateTo($"invoices/{Id}", true, true);
            Snackbar.Add("Invoice created successfully", MudBlazor.Severity.Success);
        }
        else if (_viewMode == ViewMode.Update)
        {
            Snackbar.Add("Invoice updated successfully", MudBlazor.Severity.Success);
        }
    }

    private string GetTitle()
    {
        switch (_viewMode)
        {
            case ViewMode.Create:
                return "Create Invoice";
            case ViewMode.Update:
                return "Invoice Details";
            default:
                return "";
        }
    }

    private void RemoveItem(InvoiceItemViewModel invoiceItemViewModel)
    {
        _invoiceFormModel.Items.Remove(invoiceItemViewModel);

        if (invoiceItemViewModel.Id > 0)
            _itemsToRemove.Add(invoiceItemViewModel.Id);
    }

    private void Print()
    {
        
    }


    public class InvoiceViewModel
    {
        public Provider Provider { get; set; }
        public Customer Customer { get; set; }
        public string InvoiceNumber { get; set; }
        public DateTime? InvoiceDate { get; set; }
        public string Terms { get; set; }
        public List<InvoiceItemViewModel> Items { get; set; } = new List<InvoiceItemViewModel>();
    }

    public class InvoiceItemViewModel
    {
        public int Id { get; set; }
        public ProviderService Service { get; set; }
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal Total
        {
            get { return Quantity * UnitPrice; }
        }
    }
}

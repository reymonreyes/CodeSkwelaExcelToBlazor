@page "/providers"
@using SimpleServiceInvoice.Data
@using SimpleServiceInvoice.Models
@inject IDialogService DialogService

<MudPaper Class="my-2">
    <MudToolBar>
        <MudText Typo="Typo.h6">Providers</MudText>
        <MudSpacer></MudSpacer>
        <MudTooltip Text="Create">
            <MudIconButton Icon="@Icons.Material.Outlined.Add" Href="providers/create"/>
        </MudTooltip>
    </MudToolBar>
</MudPaper>
<MudSimpleTable Hover="true" Bordered="true" Dense="true">
    <thead>
        <tr><th>Name</th><th>Address</th><th>Phone</th><th>Email</th><th></th></tr>
    </thead>
    <tbody>
        @foreach (var provider in _providers)
        {
            <tr>
                <td>@provider.Name</td>
                <td>@provider.Address</td>
                <td>@provider.Phone</td>
                <td>@provider.Email</td>
                <td>
                    <MudTooltip Text="Edit">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" Href="@($"providers/{provider.Id}/edit")"></MudIconButton>
                    </MudTooltip>
                    <MudTooltip Text="Delete">
                        <MudIconButton Icon="@Icons.Material.Filled.Clear" Color="Color.Error" Size="Size.Small" OnClick="@(() => Delete(provider))"></MudIconButton>
                    </MudTooltip>
                </td>
            </tr>
        }
    </tbody>
</MudSimpleTable>

@code {
    private List<Provider> _providers = new List<Provider>();

    protected override void OnInitialized()
    {
        GetProviders();
    }

    private async Task Delete(Provider provider)
    {
        var message = (MarkupString)$"This action is irreversible.<br/>Are you sure you want to delete this Provider?<br/><b>{provider.Name}</b>";
        var deleteConfirmed = await DialogService.ShowMessageBox("Delete Provider", message, "Yes", "No");

        if (deleteConfirmed.HasValue && deleteConfirmed.Value)
        {
            using(var context = new ApplicationDbContext())
            {
                context.Remove(provider);
                context.SaveChanges();
            }

            GetProviders();
        }
    }

    private void GetProviders()
    {
        using (var context = new ApplicationDbContext())
        {
            _providers = context.Providers.ToList();
        }
    }
}
